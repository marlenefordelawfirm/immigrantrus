import{i as f,a2 as u,bl as q,N as z,a6 as Q,eL as Y,eM as Z,eN as X,a8 as ee,a9 as te,eO as oe,h as b,B as v,ai as M,o as ne,aH as ae,u as re,ao as ie,bv as se,j as s,dJ as ce,a as p,z as L,l as S,H as O,a4 as C,_ as R,$ as le,ad as de,b0 as H,bn as ue,bx as $,d0 as pe,ae as me,Z as ge,by as he,Q as be,bk as ve,n as K}from"./index.Dg3lKJeg.js";import{S as _e}from"./SaveAndCancelButtons.DdB8J98L.js";import{S as Se}from"./SettingsPageContainer.CJeLyK8s.js";import{S as Oe}from"./SubMenuTopBarContainer.BNGFwgBo.js";import{I as J,a as fe}from"./IconNorthStar.Dg7J31mJ.js";var B;(function(e){e.Create="create",e.Edit="edit"})(B||(B={}));const Ie={object:null,action:"*"},A=e=>!e.some(a=>a.object==="*"&&a.action==="*")&&!e.some(a=>a.object===null)?[...e,Ie]:e,G=e=>Array.from(new Set(e.filter(a=>f(a.object)&&f(a.action)).map(a=>`${a.object}.${a.action}`))),Ce=e=>{const a=G(e.operations);return{targetUrl:e.targetUrl.trim(),operations:a,description:e.description,secret:e.secret}},Ue=(e,a)=>{const o=G(e.operations);return{id:a,targetUrl:e.targetUrl.trim(),operations:o,description:e.description,secret:e.secret}},We=e=>e.map(a=>{const[o,h]=a.split(".");return{object:o,action:h}}),ye=u.object({targetUrl:u.string().trim().min(1,"URL is required").refine(e=>q(e),{message:"Please enter a valid URL"}),description:u.string().optional(),operations:u.array(u.object({object:u.string().nullable(),action:u.string()})).min(1,"At least one operation is required").refine(e=>e.some(a=>a.object!==null&&a.action!==null),{message:"At least one complete operation is required"}),secret:u.string().optional()}),Te={targetUrl:"",description:"",operations:[{object:"*",action:"*"}],secret:""},De=({webhookId:e,mode:a})=>{const o=z(),{enqueueSuccessSnackBar:h,enqueueErrorSnackBar:d}=Q(),m=a===B.Create,[U]=Y(),[W]=Z(),[y]=X(),c=ee({mode:m?"onSubmit":"onTouched",resolver:te(ye),defaultValues:Te}),{loading:T,error:D}=oe({skip:m||!e,variables:{input:{id:e||""}},onCompleted:l=>{var i;const r=l.webhook;if(!r)return;const t=(i=r==null?void 0:r.operations)!=null&&i.length?We(r.operations):[],n=A(t);c.reset({targetUrl:r.targetUrl||"",description:r.description||"",operations:n,secret:r.secret||""})},onError:()=>{d({message:b._({id:"nKkohy"})})}}),{isDirty:j,isValid:_,isSubmitting:I}=c.formState;return{formConfig:c,loading:T,canSave:m?_&&!I:j&&_&&!I,handleSave:m?async l=>{try{const r=Ce(l),{data:t}=await U({variables:{input:r}}),n=t==null?void 0:t.createWebhook,i=n!=null&&n.targetUrl?`${n==null?void 0:n.targetUrl}`:"";h({message:b._({id:"Tvdycs",values:{targetUrl:i}})}),o(n?v.WebhookDetail:v.Webhooks,n?{webhookId:n.id}:void 0)}catch(r){d({apolloError:r instanceof M?r:void 0})}}:async l=>{if(!e){d({message:b._({id:"+Fb+7w"})});return}try{const r=Ue(l,e),{data:t}=await W({variables:{input:r}}),n=t==null?void 0:t.updateWebhook;c.reset(l);const i=n!=null&&n.targetUrl?`${n.targetUrl}`:"";h({message:b._({id:"otr01y",values:{targetUrl:i}})})}catch(r){d({apolloError:r instanceof M?r:void 0})}},updateOperation:(l,r,t)=>{const i=[...c.getValues("operations")];i[l]={...i[l],[r]:t},c.setValue("operations",A(i),{shouldDirty:!0,shouldValidate:!0})},removeOperation:l=>{const t=c.getValues("operations").filter((n,i)=>i!==l);c.setValue("operations",A(t),{shouldDirty:!0,shouldValidate:!0})},handleDelete:async()=>{if(!e){d({message:b._({id:"8bfORM"})});return}try{await y({variables:{input:{id:e}}}),h({message:b._({id:"2X4ecw"})}),o(v.Webhooks)}catch(l){d({apolloError:l instanceof M?l:void 0})}},isCreationMode:m,error:D}},je=340,ke=140,Ee=150,Me=140,$e=K.div`
  display: grid;
  grid-template-columns: ${({isMobile:e})=>e?`${Ee}px ${Me}px auto`:`${je}px ${ke}px auto`};
  gap: ${({theme:e})=>e.spacing(2)};
  margin-bottom: ${({theme:e})=>e.spacing(2)};
  align-items: center;
`,Ae=K.div`
  height: ${({theme:e})=>e.spacing(8)};
  width: ${({theme:e})=>e.spacing(8)};
`,V="delete-webhook-modal",xe=({webhookId:e,mode:a})=>{const{i18n:o,_:h}=ne(),d=z(),{objectMetadataItems:m}=ae(),U=re(),{getIcon:W}=ie(),{openModal:y}=se(),{formConfig:c,loading:T,canSave:D,handleSave:j,updateOperation:_,removeOperation:I,handleDelete:F,isCreationMode:g,error:w}=De({webhookId:e,mode:a}),k=()=>{if(g)return"New Webhook";const t=c.watch("targetUrl");if(f(t)&&q(t.trim()))return ve(t)};if(T&&!g||f(w))return s(ce,{});const N=[{label:"All Objects",value:"*",Icon:J},...m.map(t=>({label:t.labelPlural,value:t.nameSingular,Icon:W(t.icon)}))],P=[{label:"All",value:"*",Icon:J},{label:"Created",value:"created",Icon:ue},{label:"Updated",value:"updated",Icon:fe},{label:"Deleted",value:"deleted",Icon:$}],x=`${e}-description`,l=`${e}-target-url`,r=`${e}-secret`;return p(be,{...c,children:[s(Oe,{title:k(),reserveTitleSpace:!0,links:[{children:o._({id:"pmUArF"}),href:L(v.Workspace)},{children:o._({id:"v1kQyJ"}),href:L(v.Webhooks)},{children:g?o._({id:"isRobC"}):k()}],actionButton:s(_e,{isSaveDisabled:!D,isCancelDisabled:c.formState.isSubmitting,onCancel:()=>d(v.Webhooks),onSave:c.handleSubmit(j)}),children:p(Se,{children:[p(S,{children:[s(O,{title:o._({id:"T3juzf"}),description:o._({id:"ZS7vYp"})}),s(C,{name:"targetUrl",control:c.control,render:({field:{onChange:t,value:n},fieldState:{error:i}})=>s(R,{instanceId:l,placeholder:o._({id:"0yRnXS"}),value:n,onChange:t,error:i==null?void 0:i.message,fullWidth:!0,autoFocus:g})})]}),p(S,{children:[s(O,{title:o._({id:"Nu4oKW"}),description:o._({id:"mJ6m4C"})}),s(C,{name:"description",control:c.control,render:({field:{onChange:t,value:n}})=>s(le,{textAreaId:x,placeholder:o._({id:"Q9pNST"}),minRows:4,value:n||"",onChange:t})})]}),p(S,{children:[s(O,{title:o._({id:"cSev+j"}),description:o._({id:"xraglu"})}),s(C,{name:"operations",control:c.control,render:({field:{value:t}})=>s(de,{children:t.map((n,i)=>p($e,{isMobile:U,children:[s(H,{dropdownId:`object-webhook-type-select-${i}`,value:n.object,options:N,onChange:E=>_(i,"object",E),fullWidth:!0,emptyOption:{label:"Object",value:null}}),s(H,{dropdownId:`operation-webhook-type-select-${i}`,value:n.action,options:P,onChange:E=>_(i,"action",E),fullWidth:!0}),f(n.object)?s(pe,{Icon:$,variant:"tertiary",size:"medium",onClick:()=>I(i)}):s(Ae,{})]},i))})})]}),p(S,{children:[s(O,{title:o._({id:"8VEDbV"}),description:o._({id:"hY8F2i"})}),s(C,{name:"secret",control:c.control,render:({field:{onChange:t,value:n}})=>s(R,{instanceId:r,placeholder:o._({id:"e1v+J3"}),value:n||"",onChange:t,fullWidth:!0})})]}),!g&&p(S,{children:[s(O,{title:o._({id:"Zz6Cxn"}),description:o._({id:"KSOhjo"})}),s(me,{accent:"danger",variant:"secondary",title:o._({id:"cnGeoo"}),Icon:$,onClick:()=>y(V)})]})]})}),!g&&s(he,{confirmationPlaceholder:o._({id:"3d1wCB"}),confirmationValue:o._({id:"3d1wCB"}),modalId:V,title:o._({id:"snMaH4"}),subtitle:s(ge,{id:"GbtYRD"}),onConfirmClick:F,confirmButtonText:o._({id:"cnGeoo"})})]})};export{xe as S,B as W};
