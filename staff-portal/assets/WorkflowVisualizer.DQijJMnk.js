import{p as x,j as o,b7 as D,fG as F,dO as U,bT as k,bW as y,r as E,i as u,ao as J,dN as Q,b6 as ce,fL as pe,f5 as ue,dQ as fe,a as C,fM as we,bn as M,d0 as me,n as W,dR as z,ap as Se,bX as P,fN as Ie,dS as R,dT as _,ad as L,dU as K,M as ge,br as ke,aH as Ce,fO as he,fw as Ee,aJ as X,fP as We,bp as be,fQ as De,cL as Ne,fR as ee,bV as ye,fS as Te,fT as Oe,fU as ve,eH as Ve,d as _e,fV as Re,eK as xe,dz as Fe,dA as Me,eI as Pe,dB as Le,eJ as $,fW as Ae,bx as Be,b9 as Ge,fX as je,f3 as Y,fY as $e,fZ as ze,w as Xe,bM as Ue,a_ as Ke,bb as Z,f_ as He}from"./index.Dg3lKJeg.js";import{C as h,e as Ye,S as te,b as oe,w as Ze,W as qe,a as Je,c as Qe}from"./WorkflowDiagramStepNodeIcon.CqIy9G-o.js";import{g as A,B,a as et,P as tt,E as H,R as ot}from"./style.BQlYoUOS.js";import{u as nt,g as rt,W as st}from"./getWorkflowVersionStatusTagProps.D_ayypKq.js";import{I as at}from"./IconFilterX.gTEcLdaL.js";import"./index.C2saR20x.js";import"./string.DY8YL-MQ.js";const dt=({markerStart:e,markerEnd:t,sourceY:r,targetY:s})=>{const n=x(),[d]=A({sourceX:h,sourceY:r,targetX:h,targetY:s});return o(B,{markerStart:e,markerEnd:t,path:d,style:{stroke:n.border.color.strong}})},it="empty-trigger",G=()=>{const e=D(F),{openStepSelectInCommandMenu:t}=U(),r=k(y);return{startNodeCreation:E.useCallback(({parentStepId:n,nextStepId:d})=>{if(e({parentStepId:n,nextStepId:d}),u(r)){t(r);return}},[e,r,t])}},lt="create-step",ct=e=>e.type===lt&&e.data.nodeType==="create-step",pt=()=>{const{getIcon:e}=J(),{startNodeCreation:t}=G(),{openWorkflowTriggerTypeInCommandMenu:r,openWorkflowEditStepInCommandMenu:s}=U(),n=D(Q),d=ce(pe),{isInRightDrawer:a}=E.useContext(ue),l=k(y),i=E.useCallback(({nodes:p})=>{const c=p[0];if(a||d([]),!u(c))return;if(c.type===it){if(u(l)){r(l);return}return}if(ct(c)){t({parentStepId:c.data.parentNodeId,nextStepId:void 0});return}const w=c.data;if(n(c.id),u(l)){s(l,w.name,e(fe(w)));return}},[a,d,l,r,t,s,e,n]);return et({onChange:i}),nt(),null},ut=W.div`
  left: ${h/2}px;
  padding-top: ${({theme:e})=>e.spacing(3)};
  position: relative;
`,ft=()=>C(ut,{"data-click-outside-id":we,children:[o(Ye,{type:"target",position:tt.Top}),o(me,{Icon:M,size:"medium",ariaLabel:"Add a step"})]}),ne=()=>{const{getIcon:e}=J(),t=k(y),{openWorkflowEditStepInCommandMenu:r}=U(),s=D(Q),n=D(z);return{openWorkflowEditFilterInCommandMenu:({stepId:a,stepName:l})=>{if(!u(t))throw new Error("Workflow ID must be configured for the edge when opening a filter in command menu");s(a),n(i=>{if(!u(i))throw new Error("Workflow diagram must be defined");return{...i,nodes:i.nodes.map(p=>({...p,selected:!1}))}}),r(t,l,e(Se("FILTER")))}}},wt=W(K)`
  pointer-events: all;
`,mt=({source:e,target:t,sourceY:r,targetY:s,markerStart:n,markerEnd:d})=>{const a=x(),[l,i,p]=A({sourceX:h,sourceY:r,targetX:h,targetY:s}),c=k(y),g=P(c),{createStep:w}=Ie({workflow:g}),{startNodeCreation:S}=G(),[f,I]=E.useState(!1),m=k(F),T=m.nextStepId===t&&m.parentStepId===e,{openWorkflowEditFilterInCommandMenu:b}=ne(),V=async()=>{const v=await w({newStepType:"FILTER",parentStepId:e,nextStepId:t});u(v)&&(b({stepId:v.id,stepName:v.name}),I(!1))},O=()=>{S({parentStepId:e,nextStepId:t})};return C(L,{children:[o(B,{markerStart:n,markerEnd:d,path:l,style:{stroke:a.border.color.strong}}),o(H,{children:o(te,{"data-click-outside-id":R,labelX:i,labelY:p,onMouseEnter:()=>I(!0),onMouseLeave:()=>I(!1),children:o(oe,{shouldDisplay:T||f,children:o(wt,{className:"nodrag nopan",iconButtons:[{Icon:_,onClick:V},{Icon:M,onClick:O}]})})})})]})},St=ge`
  mutation DeleteWorkflowVersionStep($input: DeleteWorkflowVersionStepInput!) {
    deleteWorkflowVersionStep(input: $input) {
      id
      name
      type
      settings
      valid
      nextStepIds
    }
  }
`,It=()=>{const e=ke(),{objectMetadataItems:t}=Ce(),{objectPermissionsByObjectMetadataId:r}=he(),{objectMetadataItem:s}=Ee({objectNameSingular:X.WorkflowVersion}),n=We({objectNameSingular:X.WorkflowVersion}),[d]=be(St,{client:e});return{deleteWorkflowVersionStep:async l=>{var S;const i=await d({variables:{input:l}}),p=(S=i==null?void 0:i.data)==null?void 0:S.deleteWorkflowVersionStep;if(!u(p))return;const c=n(l.workflowVersionId);if(!u(c))return;const g={...c,steps:(c.steps||[]).filter(f=>f.id!==p.id).map(f=>{var I,m;return(I=f.nextStepIds)!=null&&I.includes(p.id)?{...f,nextStepIds:[...new Set([...((m=f.nextStepIds)==null?void 0:m.filter(T=>T!==p.id))||[],...p.nextStepIds||[]])]}:f})},w={steps:!0};De({objectMetadataItems:t,objectMetadataItem:s,cache:e.cache,record:g,recordGqlFields:w,objectPermissionsByObjectMetadataId:r})}}};function re(e){if(!u(e)||!u(e.currentVersion))throw new Error("Expected workflow and its current version to be defined")}const se=({workflow:e})=>{const{deleteWorkflowVersionStep:t}=It(),{updateOneRecord:r}=Ne({objectNameSingular:X.WorkflowVersion}),{deleteStepOutputSchema:s}=ee(),{getUpdatableWorkflowVersion:n}=ye(),{closeCommandMenu:d}=Te();return{deleteStep:async l=>{re(e),d();const i=await n(e);l===Oe?await r({idToUpdate:i,updateOneRecordInput:{trigger:null}}):await t({workflowVersionId:i,stepId:l}),s({stepId:l,workflowVersionId:i})}}},gt=e=>{if((e==null?void 0:e.edgeType)!=="filter")throw new Error('Edge data must be of type "filter"')},q=W(K)`
  pointer-events: all;
`,kt=W.div`
  height: 26px;
  width: 26px;
`,Ct=({source:e,target:t,sourceY:r,targetY:s,markerStart:n,markerEnd:d,data:a})=>{gt(a);const l=x(),[i,p,c]=A({sourceX:h,sourceY:r,targetX:h,targetY:s}),g=k(y),w=P(g),{deleteStep:S}=se({workflow:w}),{startNodeCreation:f}=G(),{openDropdown:I}=ve(),{closeDropdown:m}=Ve(),[T,b]=E.useState(!1),V=D(Ze),O=k(F),v=O.nextStepId===e&&(O.parentStepId===t||_e.isNonEmptyString(a.stepId)&&O.parentStepId===a.stepId),N=`${R}-${e}-${t}`,ae=k(Re,N),{openWorkflowEditFilterInCommandMenu:de}=ne(),ie=()=>{b(!0)},le=()=>{b(!1)},j=()=>{de({stepId:a.stepId,stepName:a.name})};return C(L,{children:[o(B,{markerStart:n,markerEnd:d,path:i,style:{stroke:l.border.color.strong}}),o(H,{children:o(te,{"data-click-outside-id":R,labelX:p,labelY:c,onMouseEnter:ie,onMouseLeave:le,children:C(oe,{shouldDisplay:!0,children:[o(kt,{children:T||ae||v?o(q,{className:"nodrag nopan",iconButtons:[{Icon:_,onClick:j},{Icon:xe,onClick:()=>{I({dropdownComponentInstanceIdFromProps:N})}}]}):o(q,{className:"nodrag nopan",iconButtons:[{Icon:_,onClick:j}]})}),o(Fe,{dropdownId:N,clickableComponent:o("div",{}),"data-select-disable":!0,dropdownPlacement:"bottom-start",dropdownStrategy:"absolute",dropdownOffset:{x:24,y:4},onOpen:()=>{V(!1)},onClose:()=>{V(!0)},dropdownComponents:o(Me,{widthInPixels:Pe.Narrow,children:C(Le,{children:[o($,{text:"Filter",LeftIcon:_,onClick:()=>{m(N),b(!1),j()}}),o($,{text:"Remove Filter",LeftIcon:at,onClick:()=>{if(m(N),b(!1),!u(a.stepId))throw new Error("Step ID must be configured for the edge when rendering a filter");return S(a.stepId)}}),o($,{text:"Add Node",LeftIcon:M,onClick:()=>{m(N),b(!1),f({parentStepId:a.stepId,nextStepId:t})}})]})})})]})})})]})},ht=W(K)`
  pointer-events: all;
`,Et=W.div`
  position: absolute;
  transform: ${({labelY:e})=>`translate(21px, ${(e||0)-14}px)`};
`,Wt=W.div`
  position: absolute;
  width: 48px;
  height: 52px;
  transform: translate(-13px, -16px);
  background: transparent;
`,bt=W.div`
  pointer-events: all;
  position: relative;
`,Dt=({markerStart:e,markerEnd:t,source:r,sourceY:s,target:n,targetY:d})=>{const a=x(),[l,,i]=A({sourceX:h,sourceY:s,targetX:h,targetY:d}),[p,c]=E.useState(!1),{startNodeCreation:g}=G(),w=k(F),S=w.parentStepId===r&&w.nextStepId===n;return C(L,{children:[o(B,{markerStart:e,markerEnd:t,path:l,style:{stroke:a.border.color.strong}}),o(H,{children:o(Et,{labelY:i,"data-click-outside-id":R,children:C(bt,{onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1),children:[o(Wt,{}),(p||S)&&o(ht,{className:"nodrag nopan",iconButtons:[{Icon:M,onClick:()=>{g({parentStepId:r,nextStepId:n})}}]})]})})})]})},Nt=({data:e,selected:t,variant:r,onDelete:s})=>o(Je,{name:e.name,variant:r,nodeType:e.nodeType,Icon:o(qe,{data:e}),RightFloatingElement:t?o(Ae,{size:"medium",Icon:Be,onClick:s}):void 0}),yt=({id:e,data:t,selected:r})=>{const s=k(y),n=P(s);re(n);const{deleteStep:d}=se({workflow:n});return o(Nt,{data:t,variant:"default",selected:r??!1,onDelete:()=>{d(e)}})},Tt=({versionStatus:e})=>{const t=rt({workflowVersionStatus:e});return C(ot,{children:[o(Qe,{nodeTypes:{default:yt,"create-step":ft,"empty-trigger":st},edgeTypes:{blank:dt,"filtering-disabled--editable":Dt,"empty-filter--editable":mt,"filter--editable":Ct},tagContainerTestId:"workflow-visualizer-status",tagColor:t.color,tagText:t.text}),o(pt,{})]})},Ot=({nodes:e,edges:t})=>{const r=e.filter(d=>t.every(a=>a.source!==d.id)),s=e.slice(),n=t.slice();for(const d of r){const a={id:"branch-1__create-step",type:"create-step",data:{nodeType:"create-step",parentNodeId:d.id},position:{x:0,y:0}};s.push(a),n.push({...je,type:"blank",id:Ge(),source:d.id,target:a.id})}return{nodes:s,edges:n}},vt=["selected"],Vt=(e,t)=>({nodes:t.nodes.map(s=>{const n=e.nodes.find(a=>a.id===s.id),d=vt.reduce((a,l)=>Object.assign(a,{[l]:n==null?void 0:n[l]}),{});return Object.assign(d,s)}),edges:t.edges}),_t=({workflowWithCurrentVersion:e})=>{const t=Y(z),r=D(z),s=D($e),{populateStepsOutputSchema:n}=ee(),d=Y(ze),a=Xe(Ue.IS_WORKFLOW_FILTERING_ENABLED),l=Ke(({snapshot:p,set:c})=>g=>{const w=Z(p,t),S=Ot(He({workflowVersion:g,isWorkflowFilteringEnabled:a,isEditable:!0}));let f=S;u(w)&&(f=Vt(w,S));const I=Z(p,d);u(I)&&(f.nodes=f.nodes.map(m=>({...m,selected:m.id===I})),c(d,void 0)),c(t,f)},[t,a,d]),i=e==null?void 0:e.currentVersion;return E.useEffect(()=>{if(!u(i)){s(void 0),r(void 0);return}s({workflowVersionId:i.id,trigger:i.trigger,steps:i.steps}),l(i)},[l,s,r,i]),E.useEffect(()=>{u(i)&&n(i)},[i,n]),null},Bt=({workflowId:e})=>{const t=P(e);return u(t)?C(L,{children:[o(_t,{workflowWithCurrentVersion:t}),o(Tt,{versionStatus:t.currentVersion.status})]}):null};export{Bt as WorkflowVisualizer};
