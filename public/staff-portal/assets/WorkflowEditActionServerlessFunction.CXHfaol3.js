import{d as F,ao as oe,bT as A,bU as W,b8 as re,bV as ae,bW as ue,bX as le,be as ie,r as x,bB as m,i as S,bY as p,bZ as ce,ap as de,aq as pe,ar as Ie,a as d,j as r,as as ge,at as fe,ad as T,b_ as ye,au as be,bh as D,$ as he,b$ as Fe,c0 as me,n as P,c1 as Se,c2 as Te}from"./index.Dg3lKJeg.js";import{u as we,s as ve,a as ke,g as Ce,I as L,l as Ee}from"./useServerlessFunctionUpdateFormState.D-AWTq9y.js";import{u as Ve,a as Ae,S as We}from"./useUpdateOneServerlessFunction.DLoFyx6Y.js";import{W as R,g as xe}from"./getWrongExportedFunctionMarkers.2b0m0cQD.js";import{I as De}from"./IconCode.yCarJIAU.js";import"./serverlessFunctionFragment.D9YCFdm_.js";import"./IconSquareRoundedX.C7on8jmz.js";const _=(e,t,u)=>{const s=structuredClone(e);return t.reduce((a,l,y)=>(y===t.length-1&&(a[l]=u),a[l]||{}),s),s},v=({newInput:e,oldInput:t})=>{const u={};for(const s of Object.keys(e)){const a=e[s],l=t[s];s in t?a===null&&F.isObject(l)?u[s]=null:F.isObject(a)?u[s]=v({newInput:a,oldInput:F.isObject(l)?l:{}}):u[s]=l:u[s]=a}return u},w=P.div`
  display: flex;
  flex-direction: column;
`,Le=P(Se)`
  background-color: ${({theme:e})=>e.background.secondary};
  padding-left: ${({theme:e})=>e.spacing(2)};
`,Ne=({action:e,actionOptions:t})=>{var V;const{getIcon:u}=oe(),s=e.settings.input.serverlessFunctionId,a=A(re,W),{updateOneServerlessFunction:l}=Ve(s),{getUpdatableWorkflowVersion:y}=ae(),O=A(ue),k=le(O),{availablePackages:j}=we({id:s}),[c,C]=ie(ve(s)),[E,b]=x.useState(e.settings.input.serverlessFunctionInput),{formValues:I,setFormValues:U,loading:M}=ke({serverlessFunctionId:s,serverlessFunctionVersion:"draft"}),N=async n=>{if(t.readonly===!0)return;const o=Te(n);f({...e,settings:{...e.settings,outputSchema:o}})},{testServerlessFunction:B,isTesting:g}=Ae({serverlessFunctionId:s,callback:N}),$=m(async()=>{await l({name:I.name,description:I.description,code:I.code})},500),G=async n=>{t.readonly!==!0&&(U(o=>({...o,code:{...o.code,[L]:n}})),await $(),await H(n))},H=m(async n=>{if(t.readonly===!0||!S(n))return;const o=await Ce(n),i=v({newInput:o,oldInput:e.settings.input.serverlessFunctionInput}),h=v({newInput:o,oldInput:c.input});b(i),C(se=>({...se,input:h})),f({...e,settings:{...e.settings,outputSchema:{link:{isLeaf:!0,icon:"IconVariable",tab:"test",label:"Generate Function Output"},_outputSchemaType:"LINK"},input:{...e.settings.input,serverlessFunctionInput:i}}})},500),z=async(n,o)=>{const i=_(E,o,n);b(i),f({...e,settings:{...e.settings,input:{...e.settings.input,serverlessFunctionInput:i}}})},K=async(n,o)=>{if(t.readonly===!0)return;const i=_(c.input,o,n);C(h=>({...h,input:i}))},X=async()=>{t.readonly!==!0&&(g||await B())},q=async(n,o)=>{await Ee.AutoTypings.create(n,{monaco:o,preloadPackages:!0,onlySpecifiedPackages:!0,versions:j,debounceDuration:0})},f=m(n=>{t.readonly!==!0&&t.onActionUpdate({...e,...n})},500),Y=async n=>{t.readonly===!0||!S(k)||(await y(k),await G(n))},Z=[{id:p.CODE,title:"Code",Icon:De},{id:p.TEST,title:"Test",Icon:ce}];x.useEffect(()=>{b(e.settings.input.serverlessFunctionInput)},[e]);const J=S(e.name)?e.name:"Code - Serverless Function",Q=de(e.type),ee=pe(e.type),te=Ie(e.type),ne=`${s}-test-logs`;return!M&&d(T,{children:[r(Le,{tabs:Z,behaveAsLinks:!1,componentInstanceId:W}),r(ge,{onTitleChange:n=>{f({name:n})},Icon:u(Q),iconColor:ee,initialTitle:J,headerType:te,disabled:t.readonly}),d(fe,{children:[a===p.CODE&&d(T,{children:[r(R,{functionInput:E,VariablePicker:ye,onInputChange:z,readonly:t.readonly}),r(w,{children:r(be,{height:343,value:(V=I.code)==null?void 0:V[L],language:"typescript",onChange:Y,onMount:q,setMarkers:xe,options:{readOnly:t.readonly,domReadOnly:t.readonly}})})]}),a===p.TEST&&d(T,{children:[r(R,{functionInput:c.input,onInputChange:K,readonly:t.readonly}),d(w,{children:[r(D,{children:"Result"}),r(We,{serverlessFunctionTestData:c,isTesting:g})]}),c.output.logs.length>0&&d(w,{children:[r(D,{children:"Logs"}),r(he,{textAreaId:ne,value:g?"":c.output.logs,maxRows:20,disabled:!0})]})]})]}),a===p.TEST&&r(me,{actions:[r(Fe,{title:"Test",onClick:X,disabled:g||t.readonly})]})]})};export{Ne as WorkflowEditActionServerlessFunction};
