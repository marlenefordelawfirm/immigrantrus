import{cp as j,dW as ye,T as ie,i as P,j as n,au as ce,bT as be,b8 as le,a as D,H as U,cT as ue,l as B,n as C,c1 as de,fo as Te,ae as k,bZ as pe,r as x,eH as Ie,dy as H,df as _e,d9 as q,dL as De,f9 as Q,dz as Ne,dA as we,dB as Fe,eJ as X,cm as Oe,bx as Ce,eK as xe,b9 as Z,bf as Re,bn as Ve,_ as ke,aw as $e,M as he,br as fe,bp as ve,bs as ge,N as Ae,bv as Le,ad as W,by as Pe,B as z,be as Me,a6 as Ue,bR as Be,bB as Ke,bc as ee,z as te,fp as Ye,ai as ne,fq as je}from"./index.Dg3lKJeg.js";import{S as qe,u as Je,a as We}from"./useUpdateOneServerlessFunction.DLoFyx6Y.js";import{S as ze}from"./SettingsPageContainer.CJeLyK8s.js";import{r as Ge,u as He,M as Qe,l as Xe,F as Ee,s as Ze,a as et,b as tt}from"./useServerlessFunctionUpdateFormState.D-AWTq9y.js";import{I as nt,a as rt}from"./IconTestPipe.BIeLewgh.js";import{S as st}from"./SettingsServerlessFunctionNewForm.CsOizZyL.js";import{S as V,T as G}from"./TableRow.BM7bNp8J.js";import{S as ot}from"./Table.6yesK_WS.js";import{S as at}from"./TableBody.DCdzfPFn.js";import{S as J}from"./TableHeader.D43eMMOy.js";import{S as me}from"./serverlessFunctionFragment.D9YCFdm_.js";import{S as it}from"./SubMenuTopBarContainer.BNGFwgBo.js";import{I as ct}from"./IconCode.yCarJIAU.js";import"./IconSquareRoundedX.C7on8jmz.js";import"./Breadcrumb.CQyf5Hn6.js";var O={exports:{}};const lt="16.4.5",ut={version:lt};var re;function dt(){if(re)return O.exports;re=1;var t={REACT_APP_SERVER_BASE_URL:"http://localhost:3000"};const c=j,v=Ge,p=j,h=j,y=ut.version,b=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function E(e){const a={};let r=e.toString();r=r.replace(/\r\n?/mg,`
`);let i;for(;(i=b.exec(r))!=null;){const f=i[1];let o=i[2]||"";o=o.trim();const u=o[0];o=o.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),u==='"'&&(o=o.replace(/\\n/g,`
`),o=o.replace(/\\r/g,"\r")),a[f]=o}return a}function d(e){const a=_(e),r=g.configDotenv({path:a});if(!r.parsed){const u=new Error(`MISSING_DATA: Cannot parse ${a} for an unknown reason`);throw u.code="MISSING_DATA",u}const i=s(e).split(","),f=i.length;let o;for(let u=0;u<f;u++)try{const m=i[u].trim(),w=l(r,m);o=g.decrypt(w.ciphertext,w.key);break}catch(m){if(u+1>=f)throw m}return g.parse(o)}function I(e){console.log(`[dotenv@${y}][INFO] ${e}`)}function F(e){console.log(`[dotenv@${y}][WARN] ${e}`)}function S(e){console.log(`[dotenv@${y}][DEBUG] ${e}`)}function s(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:t.DOTENV_KEY&&t.DOTENV_KEY.length>0?t.DOTENV_KEY:""}function l(e,a){let r;try{r=new URL(a)}catch(m){if(m.code==="ERR_INVALID_URL"){const w=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw w.code="INVALID_DOTENV_KEY",w}throw m}const i=r.password;if(!i){const m=new Error("INVALID_DOTENV_KEY: Missing key part");throw m.code="INVALID_DOTENV_KEY",m}const f=r.searchParams.get("environment");if(!f){const m=new Error("INVALID_DOTENV_KEY: Missing environment part");throw m.code="INVALID_DOTENV_KEY",m}const o=`DOTENV_VAULT_${f.toUpperCase()}`,u=e.parsed[o];if(!u){const m=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${o} in your .env.vault file.`);throw m.code="NOT_FOUND_DOTENV_ENVIRONMENT",m}return{ciphertext:u,key:i}}function _(e){let a=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(const r of e.path)c.existsSync(r)&&(a=r.endsWith(".vault")?r:`${r}.vault`);else a=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else a=v.resolve(process.cwd(),".env.vault");return c.existsSync(a)?a:null}function N(e){return e[0]==="~"?v.join(p.homedir(),e.slice(1)):e}function $(e){I("Loading env from encrypted .env.vault");const a=g._parseVault(e);let r=t;return e&&e.processEnv!=null&&(r=e.processEnv),g.populate(r,a,e),{parsed:a}}function A(e){const a=v.resolve(process.cwd(),".env");let r="utf8";const i=!!(e&&e.debug);e&&e.encoding?r=e.encoding:i&&S("No encoding is specified. UTF-8 is used by default");let f=[a];if(e&&e.path)if(!Array.isArray(e.path))f=[N(e.path)];else{f=[];for(const w of e.path)f.push(N(w))}let o;const u={};for(const w of f)try{const R=g.parse(c.readFileSync(w,{encoding:r}));g.populate(u,R,e)}catch(R){i&&S(`Failed to load ${w} ${R.message}`),o=R}let m=t;return e&&e.processEnv!=null&&(m=e.processEnv),g.populate(m,u,e),o?{parsed:u,error:o}:{parsed:u}}function K(e){if(s(e).length===0)return g.configDotenv(e);const a=_(e);return a?g._configVault(e):(F(`You set DOTENV_KEY but you are missing a .env.vault file at ${a}. Did you forget to build it?`),g.configDotenv(e))}function Y(e,a){const r=Buffer.from(a.slice(-64),"hex");let i=Buffer.from(e,"base64");const f=i.subarray(0,12),o=i.subarray(-16);i=i.subarray(12,-16);try{const u=h.createDecipheriv("aes-256-gcm",r,f);return u.setAuthTag(o),`${u.update(i)}${u.final()}`}catch(u){const m=u instanceof RangeError,w=u.message==="Invalid key length",R=u.message==="Unsupported state or unable to authenticate data";if(m||w){const L=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw L.code="INVALID_DOTENV_KEY",L}else if(R){const L=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw L.code="DECRYPTION_FAILED",L}else throw u}}function M(e,a,r={}){const i=!!(r&&r.debug),f=!!(r&&r.override);if(typeof a!="object"){const o=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw o.code="OBJECT_REQUIRED",o}for(const o of Object.keys(a))Object.prototype.hasOwnProperty.call(e,o)?(f===!0&&(e[o]=a[o]),i&&S(f===!0?`"${o}" is already defined and WAS overwritten`:`"${o}" is already defined and was NOT overwritten`)):e[o]=a[o]}const g={configDotenv:A,_configVault:$,_parseVault:d,config:K,decrypt:Y,parse:E,populate:M};return O.exports.configDotenv=g.configDotenv,O.exports._configVault=g._configVault,O.exports._parseVault=g._parseVault,O.exports.config=g.config,O.exports.decrypt=g.decrypt,O.exports.parse=g.parse,O.exports.populate=g.populate,O.exports=g,O.exports}var pt=dt();const Se=ye(pt),ht=({currentFilePath:t,files:c,onChange:v,setIsCodeValid:p,height:h=450,options:T=void 0})=>{const{serverlessFunctionId:y=""}=ie(),{availablePackages:b}=He({id:y}),E=c.find(S=>S.path===t),d=c.find(S=>S.path===".env"),I=async(S,s)=>{if(c.length>1){if(c.forEach(l=>{const _=s.editor.getModel(s.Uri.file(l.path));P(_)||s.editor.createModel(l.content,l.language,s.Uri.file(l.path))}),s.languages.typescript.typescriptDefaults.setCompilerOptions({...s.languages.typescript.typescriptDefaults.getCompilerOptions(),moduleResolution:s.languages.typescript.ModuleResolutionKind.NodeJs,baseUrl:"file:///src",paths:{"src/*":["file:///src/*"]},allowSyntheticDefaultImports:!0,esModuleInterop:!0,noEmit:!0,target:s.languages.typescript.ScriptTarget.ESNext}),P(d)){const l=Se.parse(d.content),_=`
          declare namespace NodeJS {
            interface ProcessEnv {
              ${Object.keys(l).map(N=>`${N}: string;`).join(`
`)}
            }
          }
  
          declare const process: {
            env: NodeJS.ProcessEnv;
          };
        `;s.languages.typescript.typescriptDefaults.setExtraLibs([{content:_,filePath:"ts:process-env.d.ts"}])}await Xe.AutoTypings.create(S,{monaco:s,preloadPackages:!0,onlySpecifiedPackages:!0,versions:b,debounceDuration:0})}},F=S=>{for(const s of S)if(s.severity===Qe.Error){p==null||p(!1);return}p==null||p(!0)};return P(E)&&P(b)&&n(ce,{height:h,value:E.content,language:E.language,onMount:I,onChange:v,onValidate:F,options:T,variant:"with-header"})},se="settings-serverless-function-editor-tab-list",ft=C(de)`
  border-bottom: none;
`,vt=({files:t,handleExecute:c,handlePublish:v,handleReset:p,resetDisabled:h,publishDisabled:T,onChange:y,setIsCodeValid:b})=>{const E=be(le,se),d=n(k,{title:"Test",variant:"primary",accent:"blue",size:"small",Icon:pe,onClick:c}),I=n(k,{title:"Publish",variant:"secondary",size:"small",Icon:nt,onClick:v,disabled:T}),F=n(k,{title:"Reset",variant:"secondary",size:"small",Icon:Te,onClick:p,disabled:h}),S=n(ft,{tabs:t.filter(s=>s.path!==".env").map(s=>({id:s.path,title:s.path.split("/").at(-1)||""})),componentInstanceId:se});return D(B,{children:[n(U,{title:"Code your function",description:"Write your function (in typescript) below"}),n(ue,{leftNodes:[S],rightNodes:[F,I,d]}),E&&n(ht,{files:t,currentFilePath:E,onChange:s=>y(E,s),setIsCodeValid:b})]})},gt=C(G)`
  grid-template-columns: 180px auto 56px;
`,Et=C(G)`
  grid-template-columns: 180px 300px 32px;
`,mt=({envVariable:t,onChange:c,onDelete:v,initialEditMode:p=!1})=>{const[h,T]=x.useState(t),[y,b]=x.useState(p),E=`settings-environment-variable-dropdown-${t.id}`,{closeDropdown:d}=Ie();return y?D(gt,{children:[n(V,{children:n(H,{autoFocus:!0,value:h.key,onChange:I=>T({...h,key:I}),placeholder:"Name",fullWidth:!0})}),n(V,{children:n(H,{value:h.value,onChange:I=>T({...h,value:I}),placeholder:"Value",fullWidth:!0})}),D(V,{children:[n(q,{accent:"tertiary",Icon:_e,onClick:()=>{t.key===""&&t.value===""&&v(),T(t),b(!1)}}),n(q,{accent:"tertiary",Icon:De,disabled:h.key===""||h.value==="",onClick:()=>{c(h),b(!1)}})]})]}):D(Et,{onClick:()=>b(!0),children:[n(V,{children:n(Q,{text:t.key})}),n(V,{children:n(Q,{text:t.value})}),n(V,{children:n(Ne,{dropdownId:E,clickableComponent:n(q,{"aria-label":"Env Variable Options",Icon:xe,accent:"tertiary"}),dropdownComponents:n(we,{children:D(Fe,{children:[n(X,{text:"Edit",LeftIcon:Oe,onClick:()=>{b(!0),d(E)}}),n(X,{text:"Delete",LeftIcon:Ce,onClick:()=>{v(),d(E)}})]})})})})]})},St=C(ke)`
  padding-bottom: ${({theme:t})=>t.spacing(2)};
  width: 100%;
`,yt=C.div`
  display: flex;
  justify-content: flex-end;
  padding-top: ${({theme:t})=>t.spacing(2)};
  @media (max-width: ${$e}px) {
    padding-top: ${({theme:t})=>t.spacing(5)};
  }
`,bt=C(at)`
  border-bottom: 1px solid ${({theme:t})=>t.border.color.light};
`,Tt=C(G)`
  grid-template-columns: 180px auto 32px;
`,It=({formValues:t,onCodeChange:c})=>{var S;const v=(S=t.code)!=null&&S[".env"]?Se.parse(t.code[".env"]):{},p=Object.entries(v).map(([s,l])=>({id:Z(),key:s,value:l})),[h,T]=x.useState(""),[y,b]=x.useState(!1),[E,d]=x.useState(p),I=x.useMemo(()=>E.filter(({key:s,value:l})=>s.toLowerCase().includes(h.toLowerCase())||l.toLowerCase().includes(h.toLowerCase())),[E,h]),F=s=>s.reduce((l,{key:_,value:N})=>_.length>0&&N.length>0?`${l}
${_}=${N}`:l,"");return D(B,{children:[n(U,{title:"Environment variables",description:"Set your function environment variables"}),n(St,{instanceId:"serverless-function-env-var-search",LeftIcon:Re,placeholder:"Search a variable",value:h,onChange:T}),D(ot,{children:[D(Tt,{children:[n(J,{children:"Name"}),n(J,{children:"Value"}),n(J,{})]}),I.length>0&&n(bt,{children:I.map(s=>n(mt,{envVariable:s,initialEditMode:y&&s.value==="",onChange:l=>{const _=E.reduce((N,{id:$,key:A})=>($===l.id?N.push(l):A!==l.key&&N.push(s),N),[]);d(_),c(".env",F(_))},onDelete:()=>{const l=E.filter(({id:_})=>_!==s.id);d(l),c(".env",F(l))}},s.id))})]}),n(yt,{children:n(k,{Icon:Ve,title:"Add Variable",size:"small",variant:"secondary",onClick:()=>{d(s=>[...s,{id:Z(),key:"",value:""}]),b(!0)}})})]})},_t=he`
  ${me}
  mutation DeleteOneServerlessFunction($input: ServerlessFunctionIdInput!) {
    deleteOneServerlessFunction(input: $input) {
      ...ServerlessFunctionFields
    }
  }
`,Dt=()=>{const t=fe(),[c]=ve(_t,{client:t});return{deleteOneServerlessFunction:async p=>await c({variables:{input:p},awaitRefetchQueries:!0,refetchQueries:[ge(Ee)??""]})}},oe="delete-function-modal",Nt=({formValues:t,serverlessFunctionId:c,onChange:v,onCodeChange:p})=>{const h=Ae(),{openModal:T}=Le(),{deleteOneServerlessFunction:y}=Dt(),b=async()=>{await y({id:c}),h(z.ServerlessFunctions)};return D(W,{children:[n(st,{formValues:t,onChange:v}),n(It,{formValues:t,onCodeChange:p}),D(B,{children:[n(U,{title:"Danger zone",description:"Delete this function"}),n(k,{accent:"danger",onClick:()=>T(oe),variant:"secondary",size:"small",title:"Delete function"})]}),n(Pe,{confirmationValue:t.name,confirmationPlaceholder:t.name,modalId:oe,title:"Function Deletion",subtitle:D(W,{children:["This action cannot be undone. This will permanently delete your function. ",n("br",{})," Please type in the function name to confirm."]}),onConfirmClick:b,confirmButtonText:"Delete function"})]})},wt=C.div`
  display: flex;
  flex-direction: column;
  gap: ${({theme:t})=>t.spacing(4)};
`,Ft=C.div`
  display: flex;
  flex-direction: column;
`,Ot=({handleExecute:t,serverlessFunctionId:c})=>{const[v,p]=Me(Ze(c)),h=T=>{p(y=>({...y,input:JSON.parse(T)}))};return D(B,{children:[n(U,{title:"Test your function",description:'Insert a JSON input, then press "Run" to test your function.'}),D(wt,{children:[D(Ft,{children:[n(ue,{title:"Input",rightNodes:[n(k,{title:"Run Function",variant:"primary",accent:"blue",size:"small",Icon:pe,onClick:t})]}),n(ce,{value:JSON.stringify(v.input,null,4),language:"json",height:200,onChange:h,variant:"with-header"})]}),n(qe,{serverlessFunctionTestData:v})]})]})},Ct=he`
  ${me}
  mutation PublishOneServerlessFunction(
    $input: PublishServerlessFunctionInput!
  ) {
    publishServerlessFunction(input: $input) {
      ...ServerlessFunctionFields
    }
  }
`,xt=()=>{const t=fe(),[c]=ve(Ct,{client:t});return{publishOneServerlessFunction:async p=>await c({variables:{input:p},awaitRefetchQueries:!0,refetchQueries:[ge(Ee)??""]})}},ae="serverless-function-detail",Wt=()=>{const{serverlessFunctionId:t=""}=ie(),{enqueueErrorSnackBar:c,enqueueSuccessSnackBar:v}=Ue(),[p,h]=Be(le,ae),[T,y]=x.useState(!0),{updateOneServerlessFunction:b}=Je(t),{publishOneServerlessFunction:E}=xt(),{formValues:d,setFormValues:I,loading:F}=et({serverlessFunctionId:t}),{testServerlessFunction:S}=We({serverlessFunctionId:t}),{code:s}=tt({id:t,version:"latest"}),l=Ke(async()=>{await b({name:d.name,description:d.description,code:d.code})},1e3),_=r=>async i=>{I(f=>({...f,[r]:i})),await l()},N=async(r,i)=>{I(f=>({...f,code:{...f.code,[r]:i}})),await l()},$=!P(s)||ee(s,d.code),A=!T||ee(s,d.code),K=async()=>{try{const r={code:s||{}};I(i=>({...i,...r})),await l()}catch(r){c({apolloError:r instanceof ne?r:void 0})}},Y=async()=>{try{await E({id:t}),v({message:"New function version has been published"})}catch(r){c({message:r instanceof ne?je(r):"An error occurred while publishing new version"})}},M=async()=>{await S(),h("test")},g=[{id:"editor",title:"Editor",Icon:ct},{id:"test",title:"Test",Icon:rt},{id:"settings",title:"Settings",Icon:Ye}],e=d.code?Object.keys(d.code).map(r=>{var i;return{path:r,language:r===".env"?"ini":"typescript",content:((i=d.code)==null?void 0:i[r])||""}}).reverse():[],a=()=>{switch(p){case"editor":return n(vt,{files:e,handleExecute:M,handlePublish:Y,handleReset:K,resetDisabled:$,publishDisabled:A,onChange:N,setIsCodeValid:y});case"test":return n(Ot,{serverlessFunctionId:t,handleExecute:M});case"settings":return n(Nt,{formValues:d,serverlessFunctionId:t,onChange:_,onCodeChange:N});default:return n(W,{})}};return!F&&n(it,{title:d.name,links:[{children:"Workspace",href:te(z.Workspace)},{children:"Functions",href:te(z.ServerlessFunctions)},{children:`${d.name}`}],children:D(ze,{children:[n(de,{tabs:g,behaveAsLinks:!1,componentInstanceId:ae}),a()]})})};export{Wt as SettingsServerlessFunctionDetail};
